//
//  RCDAboutRongCloudTableViewController.m
//  RCloudMessage
//
//  Created by litao on 15/4/27.
//  Copyright (c) 2015年 RongCloud. All rights reserved.
//

#import "RCDAboutRongCloudTableViewController.h"
#import "RCDBaseSettingTableViewCell.h"
#import "RCDLogoTableViewCell.h"
#import "RCDUIBarButtonItem.h"
#import "RCDVersionCell.h"
#import "UIColor+RCColor.h"
#import "RCDDebugTableViewController.h"
#import "RCDCommonString.h"

@interface RCDAboutRongCloudTableViewController ()
@property (nonatomic, strong) NSArray *urls;
@property (nonatomic, strong) NSDate *firstClickDate;
@property (nonatomic, assign) NSUInteger clickTimes;
@end

@implementation RCDAboutRongCloudTableViewController

- (id)initWithCoder:(NSCoder *)aDecoder {
    self = [super initWithCoder:aDecoder];
    if (self) {
        self.firstClickDate = nil;
        self.clickTimes = 0;
    }
    return self;
}

- (void)viewDidLoad {
    [super viewDidLoad];
    [self initUI];
}

#pragma mark - action
- (void)downloadNewVersionIfNeed {
    BOOL isNeedUpdate = [[DEFAULTS objectForKey:RCDNeedUpdateKey] boolValue];
    if (isNeedUpdate) {
        NSString *finalURL = [DEFAULTS objectForKey:RCDApplistURLKey];
        NSURL *applistURL = [NSURL URLWithString:finalURL];
        [[UIApplication sharedApplication] openURL:applistURL];
    }
}
- (void)openUrlFor:(NSInteger)index {
    if (index >= self.urls.count) return;
    NSString *urlString = self.urls[index];
    if (!urlString.length) {
        return;
    }
    NSURL *url = [NSURL URLWithString:urlString];
    if (url) {
        UIApplication *app = [UIApplication sharedApplication];
        if ([app canOpenURL:url]) {
            if (@available(iOS 10.0, *)) {
                [app openURL:url options:@{} completionHandler:nil];
            } else {
                // 旧系统调用旧方法（不会出现警告）
                [app openURL:url];
            }
        }
    }
}

#pragma mark - UITableViewDelegate
- (NSInteger)tableView:(UITableView *)tableView numberOfRowsInSection:(NSInteger)section {
    return 5;
}

- (UITableViewCell *)tableView:(UITableView *)tableView cellForRowAtIndexPath:(NSIndexPath *)indexPath {
    if (0 == indexPath.row) {
        static NSString *logoCellWithIdentifier = @"RCDLogoTableViewCell";
        RCDLogoTableViewCell *logoCell = [self.tableView dequeueReusableCellWithIdentifier:logoCellWithIdentifier];
        if (logoCell == nil) {
            logoCell = [[RCDLogoTableViewCell alloc] init];
        }
        logoCell.selectionStyle = UITableViewCellSelectionStyleNone;
        return logoCell;
    }
    if (3 == indexPath.row) {
        static NSString *versionCellWithIdentifier = @"RCDVersionCell";
        RCDVersionCell *versionCell = [self.tableView dequeueReusableCellWithIdentifier:versionCellWithIdentifier];
        if (versionCell == nil) {
            versionCell = [[RCDVersionCell alloc] init];
        }
        [versionCell setCellStyle:DefaultStyle_RightLabel_WithoutRightArrow];
        versionCell.leftLabel.text = RCDLocalizedString(@"ST_version");
        NSString *SealTalkVersion = [[[NSBundle mainBundle] infoDictionary] objectForKey:@"SealTalk Version"];
        versionCell.rightLabel.text = SealTalkVersion;
        BOOL isNeedUpdate = [[DEFAULTS objectForKey:RCDNeedUpdateKey] boolValue];
        if (isNeedUpdate) {
            [versionCell addNewImageView];
        }
        versionCell.selectionStyle = UITableViewCellSelectionStyleNone;
        return versionCell;
    }

    static NSString *reusableCellWithIdentifier = @"RCDBaseSettingTableViewCell";
    RCDBaseSettingTableViewCell *cell = [self.tableView dequeueReusableCellWithIdentifier:reusableCellWithIdentifier];
    if (cell == nil) {
        cell = [[RCDBaseSettingTableViewCell alloc] init];
        cell.selectionStyle = UITableViewCellSelectionStyleNone;
    }
    if (1 == indexPath.row) {
        [cell setCellStyle:DefaultStyle];
        cell.leftLabel.text = RCDLocalizedString(@"function_introduce");
    } else if (2 == indexPath.row) {
        [cell setCellStyle:DefaultStyle];
        cell.leftLabel.text = RCDLocalizedString(@"offical_website");
    } else if (4 == indexPath.row) {
        [cell setCellStyle:DefaultStyle_RightLabel_WithoutRightArrow];
        cell.leftLabel.text = RCDLocalizedString(@"SDK_version");
        NSString *version = [[[NSBundle mainBundle] infoDictionary] objectForKey:@"CFBundleShortVersionString"];
        cell.rightLabel.text = version;
    }
    return cell;
}

- (CGFloat)tableView:(UITableView *)tableView heightForRowAtIndexPath:(NSIndexPath *)indexPath {
    CGFloat height = 44.f;
    if (0 == indexPath.row) {
        height = 141.f;
    }
    return height;
}

- (void)tableView:(UITableView *)tableView didSelectRowAtIndexPath:(NSIndexPath *)indexPath {
    if (indexPath.row < 3) {
        [self openUrlFor:indexPath.row];
    } else if (indexPath.row == 3) {
        [self downloadNewVersionIfNeed];
    } else if (indexPath.row == 4) {
        if (self.clickTimes == 0) {
            self.firstClickDate = [[NSDate alloc] init];
            self.clickTimes = 1;
        } else if ([self.firstClickDate timeIntervalSinceNow] > -3) {
            self.clickTimes++;
            if (self.clickTimes >= 5) {
                [self gotoDebugModel];
            }
        } else {
            self.clickTimes = 0;
            self.firstClickDate = nil;
        }
    }
}

- (void)gotoDebugModel {
    RCDDebugTableViewController *debugVC = [RCDDebugTableViewController new];
    [self.navigationController pushViewController:debugVC animated:YES];
}

- (void)setPoweredView {
    CGRect screenBounds = self.view.frame;
    UILabel *footerLabel = [[UILabel alloc] init];
    footerLabel.textAlignment = NSTextAlignmentCenter;
    footerLabel.frame = CGRectMake(
        screenBounds.size.width / 2 - 100,
        screenBounds.size.height - 30 - 21 - self.navigationController.navigationBar.frame.size.height, 200, 21);
    footerLabel.text = @"Powered by RongCloud";
    [footerLabel setFont:[UIFont systemFontOfSize:12.f]];
    [footerLabel setTextColor:[UIColor colorWithHexString:@"999999" alpha:1.0]];
    [self.view addSubview:footerLabel];
}

- (void)clickBackBtn:(id)sender {
    [self.navigationController popViewControllerAnimated:YES];
}

- (void)addNewImageView:(RCDBaseSettingTableViewCell *)cell {
    UIImageView *newImageView = [[UIImageView alloc] initWithImage:[UIImage imageNamed:@"new"]];
    newImageView.translatesAutoresizingMaskIntoConstraints = NO;
    [cell.contentView addSubview:newImageView];
    UILabel *leftLabel = cell.leftLabel;
    NSDictionary *views = NSDictionaryOfVariableBindings(leftLabel, newImageView);
    [cell.contentView
        addConstraints:[NSLayoutConstraint constraintsWithVisualFormat:@"H:[leftLabel]-10-[newImageView(50)]"
                                                               options:0
                                                               metrics:nil
                                                                 views:views]];
    [cell.contentView addConstraints:[NSLayoutConstraint constraintsWithVisualFormat:@"V:[newImageView(23)]"
                                                                             options:0
                                                                             metrics:nil
                                                                               views:views]];
    [cell.contentView addConstraint:[NSLayoutConstraint constraintWithItem:newImageView
                                                                 attribute:NSLayoutAttributeCenterY
                                                                 relatedBy:NSLayoutRelationEqual
                                                                    toItem:cell.contentView
                                                                 attribute:NSLayoutAttributeCenterY
                                                                multiplier:1
                                                                  constant:0]];
}

- (void)initUI {
    [self setPoweredView];
    self.navigationItem.title = RCDLocalizedString(@"about_st");

    self.navigationItem.leftBarButtonItems = [RCDUIBarButtonItem getLeftBarButton:RCDLocalizedString(@"back") target:self action:@selector(clickBackBtn:)];
}

#pragma mark - getter
- (NSArray *)urls {
    if (!_urls) {
        _urls = @[
            @"http://www.wegenmi.com/",
            @"https://www.wegenmi.com/demo/introduction",
            @"http://www.wegenmi.com/"
        ];
    }
    return _urls;
}
@end
